# Created by: Pablo Carboni <pcarboni@gmail.com>
# $FreeBSD$

PORTNAME=	freediameter
PORTVERSION=	1.2.0
CATEGORIES=	net
MASTER_SITES=	http://www.freediameter.net/hg/freeDiameter/archive/
DISTNAME=	${PORTNAME:S/d/D/}-${PORTVERSION}

MAINTAINER=	pcarboni@gmail.com
COMMENT=	Free Diameter server implementation

LICENSE=	BSD3CLAUSE

LIB_DEPENDS=	libidn.so:${PORTSDIR}/dns/libidn \
		libgnutls.so:${PORTSDIR}/security/gnutls \
		libgcrypt.so:${PORTSDIR}/security/libgcrypt

SUB_FILES=	pkg-message pkg-install pkg-deinstall

USES=		bison cmake
USE_LDCONFIG=	yes
USE_RC_SUBR=	freediameterd

CMAKE_NOCOLOR=	yes
CMAKE_VERBOSE=	yes

CMAKE_ARGS=	-DSCTP_USE_MAPPED_ADDRESSES:BOOL=ON

PORTDOCS=	LICENSE NEWS README INSTALL*

DOCSDIR=	${PREFIX}/share/doc/${PORTNAME:S/d/D/}
EXAMPLESDIR=	${PREFIX}/share/examples/${PORTNAME:S/d/D/}
ETCDIR=		${PREFIX}/etc/${PORTNAME:S/d/D/}

.include "${.CURDIR}/Makefile.options"
.include "${.CURDIR}/Makefile.options.desc"

BUILD_ACL_WL_CMAKE_ON=				-DBUILD_ACL_WL:BOOL=ON
BUILD_ACL_WL_CMAKE_OFF=				-DBUILD_ACL_WL:BOOL=OFF
BUILD_DBG_MONITOR_CMAKE_ON=			-DBUILD_DBG_MONITOR:BOOL=ON
BUILD_DBG_MONITOR_CMAKE_OFF=			-DBUILD_DBG_MONITOR:BOOL=OFF
BUILD_DBG_MSG_DUMPS_CMAKE_ON=			-DBUILD_DBG_MSG_DUMPS:BOOL=ON
BUILD_DBG_MSG_DUMPS_CMAKE_OFF=			-DBUILD_DBG_MSG_DUMPS:BOOL=OFF
BUILD_DBG_MSG_TIMINGS_CMAKE_ON=			-DBUILD_DBG_MSG_TIMINGS:BOOL=ON
BUILD_DBG_MSG_TIMINGS_CMAKE_OFF=		-DBUILD_DBG_MSG_TIMINGS:BOOL=OFF
BUILD_DBG_RT_CMAKE_ON=				-DBUILD_DBG_RT:BOOL=ON
BUILD_DBG_RT_CMAKE_OFF=				-DBUILD_DBG_RT:BOOL=OFF
BUILD_DICT_DCCA_CMAKE_ON=			-DBUILD_DICT_DCCA:BOOL=ON
BUILD_DICT_DCCA_CMAKE_OFF=			-DBUILD_DICT_DCCA:BOOL=OFF
BUILD_DICT_DCCA_3GPP_CMAKE_ON=			-DBUILD_DICT_DCCA_3GPP:BOOL=ON
BUILD_DICT_DCCA_3GPP_CMAKE_OFF=			-DBUILD_DICT_DCCA_3GPP:BOOL=OFF
BUILD_DICT_DCCA_STARENT_CMAKE_ON=		-DBUILD_DICT_DCCA_STARENT:BOOL=ON
BUILD_DICT_DCCA_STARENT_CMAKE_OFF=		-DBUILD_DICT_DCCA_STARENT:BOOL=OFF
BUILD_DICT_EAP_CMAKE_ON=			-DBUILD_DICT_EAP:BOOL=ON
BUILD_DICT_EAP_CMAKE_OFF=			-DBUILD_DICT_EAP:BOOL=OFF
BUILD_DICT_MIP6A_CMAKE_ON=			-DBUILD_DICT_MIP6A:BOOL=ON
BUILD_DICT_MIP6A_CMAKE_OFF=			-DBUILD_DICT_MIP6A:BOOL=OFF
BUILD_DICT_MIP6I_CMAKE_ON=			-DBUILD_DICT_MIP6I:BOOL=ON
BUILD_DICT_MIP6I_CMAKE_OFF=			-DBUILD_DICT_MIP6I:BOOL=OFF
BUILD_DICT_NASREQ_CMAKE_ON=			-DBUILD_DICT_NASREQ:BOOL=ON
BUILD_DICT_NASREQ_CMAKE_OFF=			-DBUILD_DICT_NASREQ:BOOL=OFF
BUILD_DICT_NAS_MIPV6_CMAKE_ON=			-DBUILD_DICT_NAS_MIPV6:BOOL=ON
BUILD_DICT_NAS_MIPV6_CMAKE_OFF=			-DBUILD_DICT_NAS_MIPV6:BOOL=OFF
BUILD_DICT_RFC5777_CMAKE_ON=			-DBUILD_DICT_RFC5777:BOOL=ON
BUILD_DICT_RFC5777_CMAKE_OFF=			-DBUILD_DICT_RFC5777:BOOL=OFF
BUILD_DICT_SIP_CMAKE_ON=			-DBUILD_DICT_SIP:BOOL=ON
BUILD_DICT_SIP_CMAKE_OFF=			-DBUILD_DICT_SIP:BOOL=OFF
BUILD_RT_BUSYPEERS_CMAKE_ON=			-DBUILD_RT_BUSYPEERS:BOOL=ON
BUILD_RT_BUSYPEERS_CMAKE_OFF=			-DBUILD_RT_BUSYPEERS:BOOL=OFF
BUILD_RT_DEFAULT_CMAKE_ON=			-DBUILD_RT_DEFAULT:BOOL=ON
BUILD_RT_DEFAULT_CMAKE_OFF=			-DBUILD_RT_DEFAULT:BOOL=OFF
BUILD_RT_IGNORE_DH_CMAKE_ON=			-DBUILD_RT_IGNORE_DH:BOOL=ON
BUILD_RT_IGNORE_DH_CMAKE_OFF=			-DBUILD_RT_IGNORE_DH:BOOL=OFF
BUILD_RT_LOAD_BALANCE_CMAKE_ON=			-DBUILD_RT_LOAD_BALANCE:BOOL=ON
BUILD_RT_LOAD_BALANCE_CMAKE_OFF=		-DBUILD_RT_LOAD_BALANCE:BOOL=OFF
BUILD_RT_REDIRECT_CMAKE_ON=			-DBUILD_RT_REDIRECT:BOOL=ON
BUILD_RT_REDIRECT_CMAKE_OFF=			-DBUILD_RT_REDIRECT:BOOL=OFF
BUILD_TEST_APP_CMAKE_ON=			-DBUILD_TEST_APP:BOOL=ON
BUILD_TEST_APP_CMAKE_OFF=			-DBUILD_TEST_APP:BOOL=OFF

BUILD_APP_ACCT_CMAKE_ON=			-DBUILD_APP_ACCT:BOOL=ON
BUILD_APP_ACCT_CMAKE_OFF=			-DBUILD_APP_ACCT:BOOL=OFF
BUILD_APP_ACCT_USES=				pgsql

BUILD_APP_DIAMEAP_CMAKE_ON=			-DBUILD_APP_DIAMEAP:BOOL=ON
BUILD_APP_DIAMEAP_CMAKE_OFF=			-DBUILD_APP_DIAMEAP:BOOL=OFF
BUILD_APP_DIAMEAP_USES=				pgsql

BUILD_APP_RADGW_CMAKE_ON=			-DBUILD_APP_RADGW:BOOL=ON
BUILD_APP_RADGW_CMAKE_OFF=			-DBUILD_APP_RADGW:BOOL=OFF
BUILD_APP_RADGW_USES=				pgsql

BUILD_APP_REDIRECT_CMAKE_ON=			-DBUILD_APP_REDIRECT:BOOL=ON
BUILD_APP_REDIRECT_CMAKE_OFF=			-DBUILD_APP_REDIRECT:BOOL=OFF
BUILD_APP_REDIRECT_USES=			pgsql

BUILD_APP_SIP_CMAKE_ON=				-DBUILD_APP_SIP:BOOL=ON
BUILD_APP_SIP_CMAKE_OFF=			-DBUILD_APP_SIP:BOOL=OFF
BUILD_APP_SIP_USE=				mysql=client

BUILD_DBG_INTERACTIVE_CMAKE_ON=			-DBUILD_DBG_INTERACTIVE:BOOL=ON
BUILD_DBG_INTERACTIVE_CMAKE_OFF=		-DBUILD_DBG_INTERACTIVE:BOOL=OFF
BUILD_DBG_INTERACTIVE_BUILD_DEPENDS=		swig2.0:${PORTSDIR}/devel/swig20

BUILD_DICT_LEGACY_XML_CMAKE_ON=			-DBUILD_DICT_LEGACY_XML:BOOL=ON
BUILD_DICT_LEGACY_XML_CMAKE_OFF=		-DBUILD_DICT_LEGACY_XML:BOOL=OFF
BUILD_DICT_LEGACY_XML_LIB_DEPENDS=		libxml2.so:${PORTSDIR}/textproc/libxml2

BUILD_RT_EREG_CMAKE_ON=				-DBUILD_RT_EREG:BOOL=ON
BUILD_RT_EREG_CMAKE_OFF=			-DBUILD_RT_EREG:BOOL=OFF
BUILD_TEST_NETEMUL_CMAKE_ON=			-DBUILD_TEST_NETEMUL:BOOL=ON
BUILD_TEST_NETEMUL_CMAKE_OFF=			-DBUILD_TEST_NETEMUL:BOOL=OFF
BUILD_TEST_SIP_CMAKE_ON=			-DBUILD_TEST_SIP:BOOL=ON
BUILD_TEST_SIP_CMAKE_OFF=			-DBUILD_TEST_SIP:BOOL=OFF
DEBUG_SCTP_CMAKE_ON=				-DDEBUG_SCTP:BOOL=ON
DEBUG_SCTP_CMAKE_OFF=				-DDEBUG_SCTP:BOOL=OFF
DIAMID_IDNA_IGNORE_CMAKE_ON=			-DDIAMID_IDNA_IGNORE:BOOL=ON
DIAMID_IDNA_IGNORE_CMAKE_OFF=			-DDIAMID_IDNA_IGNORE:BOOL=OFF
DIAMID_IDNA_REJECT_CMAKE_ON=			-DDIAMID_IDNA_REJECT:BOOL=ON
DIAMID_IDNA_REJECT_CMAKE_OFF=			-DDIAMID_IDNA_REJECT:BOOL=OFF
DISABLE_PEER_EXPIRY_CMAKE_ON=			-DDISABLE_PEER_EXPIRY:BOOL=ON
DISABLE_PEER_EXPIRY_CMAKE_OFF=			-DDISABLE_PEER_EXPIRY:BOOL=OFF
DISABLE_SCTP_CMAKE_ON=				-DDISABLE_SCTP:BOOL=ON
DISABLE_SCTP_CMAKE_OFF=				-DDISABLE_SCTP:BOOL=OFF
ERRORS_ON_TODO_CMAKE_ON=			-DERRORS_ON_TODO:BOOL=ON
ERRORS_ON_TODO_CMAKE_OFF=			-DERRORS_ON_TODO:BOOL=OFF
WORKAROUND_ACCEPT_INVALID_VSAI_CMAKE_ON=	-DWORKAROUND_ACCEPT_INVALID_VSAI:BOOL=ON
WORKAROUND_ACCEPT_INVALID_VSAI_CMAKE_OFF=	-DWORKAROUND_ACCEPT_INVALID_VSAI:BOOL=OFF

.include <bsd.port.options.mk>

pre-build:
.if ${PORT_OPTIONS:MBUILD_TESTING} && !${PORT_OPTIONS:MDISABLE_SCTP}
BROKEN=	SCTP tests broken. Try again by disabling BUILD_TESTING or by enabling DISABLE_SCTP support
.endif

pre-install:
.if ${PORT_OPTIONS:MDISABLE_SCTP}
	@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} && \
	${MAKE_CMD} ${MAKE_FLAGS} ${MAKEFILE} ${MAKE_ARGS} test)
.endif

post-install:
	${MKDIR} ${STAGEDIR}${EXAMPLESDIR}
	cd ${WRKSRC}/doc && ${COPYTREE_SHARE} . ${STAGEDIR}${EXAMPLESDIR}

	${MKDIR} ${STAGEDIR}${DOCSDIR}
	cd ${WRKSRC}/ && ${INSTALL_DATA} ${PORTDOCS} ${STAGEDIR}${DOCSDIR}/
	cd ${WRKSRC} && ${COPYTREE_SHARE} contrib ${STAGEDIR}${DOCSDIR}

	${MKDIR} ${STAGEDIR}${ETCDIR}
	cd ${WRKSRC}/doc/single_host && ${COPYTREE_SHARE} . ${STAGEDIR}${ETCDIR}

	${REINPLACE_CMD} -i "" -e 's|%%ETCDIR%%|${ETCDIR}|g' \
				-e 's|%%LIBEXECDIR%%|${PREFIX}/libexec|g' \
				${WRKSRC}/doc/single_host/freeDiameter-1.conf

	${INSTALL_DATA} ${WRKSRC}/doc/single_host/freeDiameter-1.conf ${STAGEDIR}${ETCDIR}/freeDiameter.conf.sample
	${INSTALL_DATA} ${WRKSRC}/doc/single_host/freeDiameter-1.conf ${STAGEDIR}${ETCDIR}/freeDiameter.conf

.include <bsd.port.mk>
